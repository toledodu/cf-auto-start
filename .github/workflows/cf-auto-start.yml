name: SAP BTP Auto Start

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '30 0 * * *'  # æ¯å¤© UTC æ—¶é—´ 00:30ï¼ˆåŒ—äº¬æ—¶é—´ 08:30ï¼‰

jobs:
  start-apps:
    name: Start SAP BTP Applications
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®è¶…æ—¶æ—¶é—´

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Run CF Auto Start Script
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        CF_USERNAME_1: ${{ secrets.CF_USERNAME_1 }}
        CF_PASSWORD_1: ${{ secrets.CF_PASSWORD_1 }}
        CF_ORG_1: ${{ secrets.CF_ORG_1 }}
        CF_APPS_1: ${{ secrets.CF_APPS_1 }}
        CF_USERNAME_2: ${{ secrets.CF_USERNAME_2 }}
        CF_PASSWORD_2: ${{ secrets.CF_PASSWORD_2 }}
        CF_ORG_2: ${{ secrets.CF_ORG_2 }}
        CF_APPS_2: ${{ secrets.CF_APPS_2 }}
      run: |
        python cf-autostart.py

    - name: Send success notification
      if: success()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="âœ… <b>SAP BTP å¯åŠ¨æˆåŠŸï¼</b>%0A%0Aâ° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')%0AğŸ“Š çŠ¶æ€: æ‰€æœ‰åº”ç”¨å¯åŠ¨å®Œæˆ%0A%0A<code>ä¸‹æ¬¡æ‰§è¡Œ: æ˜å¤© 08:30</code>" \
          -d parse_mode="HTML" \
          -d disable_web_page_preview="true"

    - name: Send failure notification
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="âŒ <b>SAP BTP å¯åŠ¨å¤±è´¥</b>%0A%0AğŸ“¦ å·¥ä½œæµ: $GITHUB_WORKFLOW%0AğŸ·ï¸ è¿è¡ŒID: $GITHUB_RUN_ID%0Aâ° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')%0A%0AğŸ” æŸ¥çœ‹ " \
          -d parse_mode="HTML" \
          -d disable_web_page_preview="true"
